library("duckdb")
library("dplyr")
raw_con <-
  dbConnect(duckdb(
    dbdir = here::here("data", "db", "derived_tables3.duckdb")
  ))

dbListTables(raw_con)

# 
# tbl(raw_con, "tree_raw") |>
#   filter(INVYR >= 2000) |>
#   mutate(TREE_COMPOSITE_ID = paste(STATECD, UNITCD, COUNTYCD, PLOT, SUBP, TREE, sep = "_"),
#          PLOT_COMPOSITE_ID = paste(STATECD, UNITCD, COUNTYCD, PLOT, sep = "_")) |>
#   rename(TREE_CN = CN) |>
#   select(-c(CREATED_BY, CREATED_DATE, CREATED_IN_INSTANCE, MODIFIED_BY, MODIFIED_DATE, MODIFIED_IN_INSTANCE)) |>
#   show_query()
#   to_duckdb(table_name = "tree", con = derived_con)
#   #arrow::to_duckdb(table_name = "tree", con = derived_con)

dbSendQuery(raw_con, "CREATE TABLE tree AS SELECT
  CN AS TREE_CN,
  PLT_CN,
  PREV_TRE_CN,
  INVYR,
  STATECD,
  UNITCD,
  COUNTYCD,
  PLOT,
  SUBP,
  TREE,
  CONDID,
  AZIMUTH,
  DIST,
  PREVCOND,
  STATUSCD,
  SPCD,
  SPGRPCD,
  DIA,
  DIAHTCD,
  HT,
  HTCD,
  ACTUALHT,
  TREECLCD,
  CR,
  CCLCD,
  TREEGRCD,
  AGENTCD,
  CULL,
  DAMLOC1,
  DAMTYP1,
  DAMSEV1,
  DAMLOC2,
  DAMTYP2,
  DAMSEV2,
  DECAYCD,
  STOCKING,
  WDLDSTEM,
  VOLCFNET,
  VOLCFGRS,
  VOLCSNET,
  VOLCSGRS,
  VOLBFNET,
  VOLBFGRS,
  VOLCFSND,
  DIACHECK,
  MORTYR,
  SALVCD,
  UNCRCD,
  CPOSCD,
  CLIGHTCD,
  CVIGORCD,
  CDENCD,
  CDIEBKCD,
  TRANSCD,
  TREEHISTCD,
  BHAGE,
  TOTAGE,
  CULLDEAD,
  CULLFORM,
  CULLMSTOP,
  CULLBF,
  CULLCF,
  BFSND,
  CFSND,
  SAWHT,
  BOLEHT,
  FORMCL,
  HTCALC,
  HRDWD_CLUMP_CD,
  SITREE,
  MORTCD,
  HTDMP,
  ROUGHCULL,
  MIST_CL_CD,
  CULL_FLD,
  RECONCILECD,
  PREVDIA,
  P2A_GRM_FLG,
  TREECLCD_NERS,
  TREECLCD_SRS,
  TREECLCD_NCRS,
  TREECLCD_RMRS,
  STANDING_DEAD_CD,
  PREV_STATUS_CD,
  PREV_WDLDSTEM,
  TPA_UNADJ,
  DRYBIO_BOLE,
  DRYBIO_STUMP,
  DRYBIO_BG,
  CARBON_AG,
  CARBON_BG,
  CYCLE,
  SUBCYCLE,
  BORED_CD_PNWRS,
  DAMLOC1_PNWRS,
  DAMLOC2_PNWRS,
  DIACHECK_PNWRS,
  DMG_AGENT1_CD_PNWRS,
  DMG_AGENT2_CD_PNWRS,
  DMG_AGENT3_CD_PNWRS,
  MIST_CL_CD_PNWRS,
  SEVERITY1_CD_PNWRS,
  SEVERITY1A_CD_PNWRS,
  SEVERITY1B_CD_PNWRS,
  SEVERITY2_CD_PNWRS,
  SEVERITY2A_CD_PNWRS,
  SEVERITY2B_CD_PNWRS,
  SEVERITY3_CD_PNWRS,
  UNKNOWN_DAMTYP1_PNWRS,
  UNKNOWN_DAMTYP2_PNWRS,
  PREV_PNTN_SRS,
  DISEASE_SRS,
  DIEBACK_SEVERITY_SRS,
  DAMAGE_AGENT_CD1,
  DAMAGE_AGENT_CD2,
  DAMAGE_AGENT_CD3,
  CENTROID_DIA,
  CENTROID_DIA_HT,
  CENTROID_DIA_HT_ACTUAL,
  UPPER_DIA,
  UPPER_DIA_HT,
  VOLCSSND,
  DRYBIO_SAWLOG,
  DAMAGE_AGENT_CD1_SRS,
  DAMAGE_AGENT_CD2_SRS,
  DAMAGE_AGENT_CD3_SRS,
  DRYBIO_AG,
  ACTUALHT_CALC,
  ACTUALHT_CALC_CD,
  CULL_BF_ROTTEN,
  CULL_BF_ROTTEN_CD,
  CULL_BF_ROUGH,
  CULL_BF_ROUGH_CD,
  PREVDIA_FLD,
  TREECLCD_31_NCRS,
  TREE_GRADE_NCRS,
  BOUGHS_AVAILABLE_NCRS,
  BOUGHS_HRVST_NCRS,
  TREECLCD_31_NERS,
  AGENTCD_NERS,
  BFSNDCD_NERS,
  AGECHKCD_RMRS,
  PREV_ACTUALHT_RMRS,
  PREV_AGECHKCD_RMRS,
  PREV_BHAGE_RMRS,
  PREV_HT_RMRS,
  PREV_TOTAGE_RMRS,
  PREV_TREECLCD_RMRS,
  RADAGECD_RMRS,
  RADGRW_RMRS,
  VOLBSGRS,
  VOLBSNET,
  SAPLING_FUSIFORM_SRS,
  EPIPHYTE_PNWRS,
  ROOT_HT_PNWRS,
  CAVITY_USE_PNWRS,
  CORE_LENGTH_PNWRS,
  CULTURALLY_KILLED_PNWRS,
  DIA_EST_PNWRS,
  GST_PNWRS,
  INC10YR_PNWRS,
  INC5YRHT_PNWRS,
  INC5YR_PNWRS,
  RING_COUNT_INNER_2INCHES_PNWRS,
  RING_COUNT_PNWRS,
  SNAG_DIS_CD_PNWRS,
  CONEPRESCD1,
  CONEPRESCD2,
  CONEPRESCD3,
  MASTCD,
  VOLTSGRS,
  VOLTSGRS_BARK,
  VOLTSSND,
  VOLTSSND_BARK,
  VOLCFGRS_STUMP,
  VOLCFGRS_STUMP_BARK,
  VOLCFSND_STUMP,
  VOLCFSND_STUMP_BARK,
  VOLCFGRS_BARK,
  VOLCFGRS_TOP,
  VOLCFGRS_TOP_BARK,
  VOLCFSND_BARK,
  VOLCFSND_TOP,
  VOLCFSND_TOP_BARK,
  VOLCFNET_BARK,
  VOLCSGRS_BARK,
  VOLCSSND_BARK,
  VOLCSNET_BARK,
  DRYBIO_STEM,
  DRYBIO_STEM_BARK,
  DRYBIO_STUMP_BARK,
  DRYBIO_BOLE_BARK,
  DRYBIO_BRANCH,
  DRYBIO_FOLIAGE,
  DRYBIO_SAWLOG_BARK,
  CONCAT_WS('_', STATECD, UNITCD, COUNTYCD, PLOT, SUBP, TREE) AS TREE_COMPOSITE_ID,
  CONCAT_WS('_', STATECD, UNITCD, COUNTYCD, PLOT) AS PLOT_COMPOSITE_ID
FROM tree_raw
WHERE (INVYR >= 2000.0)")
# 
# tbl(raw_con, "plot_raw") |>
#   filter(INVYR >= 2000) |>
#   mutate(PLOT_COMPOSITE_ID = paste(STATECD, UNITCD, COUNTYCD, PLOT, sep = "_")) |>
#   rename(PLOT_CN = CN) |>
#   select(-c(CREATED_BY, CREATED_DATE, CREATED_IN_INSTANCE, MODIFIED_BY, MODIFIED_DATE, MODIFIED_IN_INSTANCE)) |>
#   show_query() 

dbSendQuery(raw_con, "CREATE TABLE plot AS SELECT
  CN AS PLOT_CN,
  SRV_CN,
  CTY_CN,
  PREV_PLT_CN,
  INVYR,
  STATECD,
  UNITCD,
  COUNTYCD,
  PLOT,
  PLOT_STATUS_CD,
  PLOT_NONSAMPLE_REASN_CD,
  MEASYEAR,
  MEASMON,
  MEASDAY,
  REMPER,
  KINDCD,
  DESIGNCD,
  RDDISTCD,
  WATERCD,
  LAT,
  LON,
  ELEV,
  GROW_TYP_CD,
  MORT_TYP_CD,
  P2PANEL,
  P3PANEL,
  ECOSUBCD,
  CONGCD,
  MANUAL,
  KINDCD_NC,
  QA_STATUS,
  MICROPLOT_LOC,
  DECLINATION,
  EMAP_HEX,
  SAMP_METHOD_CD,
  SUBP_EXAMINE_CD,
  MACRO_BREAKPOINT_DIA,
  INTENSITY,
  CYCLE,
  SUBCYCLE,
  ECO_UNIT_PNW,
  TOPO_POSITION_PNW,
  NF_SAMPLING_STATUS_CD,
  NF_PLOT_STATUS_CD,
  NF_PLOT_NONSAMPLE_REASN_CD,
  P2VEG_SAMPLING_STATUS_CD,
  P2VEG_SAMPLING_LEVEL_DETAIL_CD,
  INVASIVE_SAMPLING_STATUS_CD,
  INVASIVE_SPECIMEN_RULE_CD,
  DESIGNCD_P2A,
  MANUAL_DB,
  SUBPANEL,
  COLOCATED_CD_RMRS,
  CONDCHNGCD_RMRS,
  FUTFORCD_RMRS,
  MANUAL_NCRS,
  MANUAL_NERS,
  MANUAL_RMRS,
  PAC_ISLAND_PNWRS,
  PLOT_SEASON_NERS,
  PRECIPITATION,
  PREV_MICROPLOT_LOC_RMRS,
  PREV_PLOT_STATUS_CD_RMRS,
  REUSECD1,
  REUSECD2,
  REUSECD3,
  CONCAT_WS('_', STATECD, UNITCD, COUNTYCD, PLOT) AS PLOT_COMPOSITE_ID
FROM plot_raw
WHERE (INVYR >= 2000.0)")


# 
# tbl(raw_con, "cond_raw")|>
#   filter(INVYR >= 2000) |>
#   mutate(PLOT_COMPOSITE_ID = paste(STATECD, UNITCD, COUNTYCD, PLOT, sep = "_")) |>
#   rename(COND_CN = CN) |>
#   select(-c(CREATED_BY, CREATED_DATE, CREATED_IN_INSTANCE, MODIFIED_BY, MODIFIED_DATE, MODIFIED_IN_INSTANCE)) |>
#   show_query()
# collect() |>
#   arrow::to_duckdb(table_name = "cond", con = derived_con)

dbSendQuery(raw_con, "CREATE TABLE cond AS SELECT
   CN AS COND_CN,
  PLT_CN,
  INVYR,
  STATECD,
  UNITCD,
  COUNTYCD,
  PLOT,
  CONDID,
  COND_STATUS_CD,
  COND_NONSAMPLE_REASN_CD,
  RESERVCD,
  OWNCD,
  OWNGRPCD,
  FORINDCD,
  ADFORCD,
  FORTYPCD,
  FLDTYPCD,
  MAPDEN,
  STDAGE,
  STDSZCD,
  FLDSZCD,
  SITECLCD,
  SICOND,
  SIBASE,
  SISP,
  STDORGCD,
  STDORGSP,
  PROP_BASIS,
  CONDPROP_UNADJ,
  MICRPROP_UNADJ,
  SUBPPROP_UNADJ,
  MACRPROP_UNADJ,
  SLOPE,
  ASPECT,
  PHYSCLCD,
  GSSTKCD,
  ALSTKCD,
  DSTRBCD1,
  DSTRBYR1,
  DSTRBCD2,
  DSTRBYR2,
  DSTRBCD3,
  DSTRBYR3,
  TRTCD1,
  TRTYR1,
  TRTCD2,
  TRTYR2,
  TRTCD3,
  TRTYR3,
  PRESNFCD,
  BALIVE,
  FLDAGE,
  ALSTK,
  GSSTK,
  FORTYPCDCALC,
  HABTYPCD1,
  HABTYPCD1_PUB_CD,
  HABTYPCD1_DESCR_PUB_CD,
  HABTYPCD2,
  HABTYPCD2_PUB_CD,
  HABTYPCD2_DESCR_PUB_CD,
  MIXEDCONFCD,
  VOL_LOC_GRP,
  SITECLCDEST,
  SITETREE_TREE,
  SITECL_METHOD,
  CARBON_DOWN_DEAD,
  CARBON_LITTER,
  CARBON_SOIL_ORG,
  CARBON_UNDERSTORY_AG,
  CARBON_UNDERSTORY_BG,
  CYCLE,
  SUBCYCLE,
  SOIL_ROOTING_DEPTH_PNW,
  GROUND_LAND_CLASS_PNW,
  PLANT_STOCKABILITY_FACTOR_PNW,
  STND_COND_CD_PNWRS,
  STND_STRUC_CD_PNWRS,
  STUMP_CD_PNWRS,
  FIRE_SRS,
  GRAZING_SRS,
  HARVEST_TYPE1_SRS,
  HARVEST_TYPE2_SRS,
  HARVEST_TYPE3_SRS,
  LAND_USE_SRS,
  OPERABILITY_SRS,
  STAND_STRUCTURE_SRS,
  NF_COND_STATUS_CD,
  NF_COND_NONSAMPLE_REASN_CD,
  CANOPY_CVR_SAMPLE_METHOD_CD,
  LIVE_CANOPY_CVR_PCT,
  LIVE_MISSING_CANOPY_CVR_PCT,
  NBR_LIVE_STEMS,
  OWNSUBCD,
  INDUSTRIALCD_FIADB,
  RESERVCD_5,
  ADMIN_WITHDRAWN_CD,
  CHAINING_CD,
  LAND_COVER_CLASS_CD_RET,
  AFFORESTATION_CD,
  PREV_AFFORESTATION_CD,
  DWM_FUELBED_TYPCD,
  NVCS_PRIMARY_CLASS,
  NVCS_LEVEL_1_CD,
  NVCS_LEVEL_2_CD,
  NVCS_LEVEL_3_CD,
  NVCS_LEVEL_4_CD,
  NVCS_LEVEL_5_CD,
  NVCS_LEVEL_6_CD,
  NVCS_LEVEL_7_CD,
  NVCS_LEVEL_8_CD,
  AGE_BASIS_CD_PNWRS,
  COND_STATUS_CHNG_CD_RMRS,
  CRCOVPCT_RMRS,
  DOMINANT_SPECIES1_PNWRS,
  DOMINANT_SPECIES2_PNWRS,
  DOMINANT_SPECIES3_PNWRS,
  DSTRBCD1_P2A,
  DSTRBCD2_P2A,
  DSTRBCD3_P2A,
  DSTRBYR1_P2A,
  DSTRBYR2_P2A,
  DSTRBYR3_P2A,
  FLDTYPCD_30,
  FOREST_COMMUNITY_PNWRS,
  LAND_USECD_RMRS,
  MAICF,
  PCTBARE_RMRS,
  QMD_RMRS,
  RANGETYPCD_RMRS,
  SDIMAX_RMRS,
  SDIPCT_RMRS,
  SDI_RMRS,
  STAND_STRUCTURE_ME_NERS,
  TREES_PRESENT_NCRS,
  TREES_PRESENT_NERS,
  TRTCD1_P2A,
  TRTCD2_P2A,
  TRTCD3_P2A,
  TRTOPCD,
  TRTYR1_P2A,
  TRTYR2_P2A,
  TRTYR3_P2A,
  LAND_COVER_CLASS_CD,
  SIEQN_REF_CD,
  SICOND_FVS,
  SIBASE_FVS,
  SISP_FVS,
  SIEQN_REF_CD_FVS,
  MQUADPROP_UNADJ,
  SOILPROP_UNADJ,
  FOREST_COND_STATUS_CHANGE_CD,
  CONCAT_WS('_', STATECD, UNITCD, COUNTYCD, PLOT) AS PLOT_COMPOSITE_ID
FROM cond_raw
WHERE (INVYR >= 2000.0)")  

#   
# dbSendQuery(derived_con, "CREATE TABLE tree AS SELECT * FROM tree")
# dbSendQuery(derived_con, "CREATE TABLE plot AS SELECT * FROM plot")
# dbSendQuery(derived_con, "CREATE TABLE cond AS SELECT * FROM cond")


dbDisconnect(raw_con, shutdown = TRUE)

