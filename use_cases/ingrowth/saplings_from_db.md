# Extract sapling transition tables


# Pulling trees

``` r
source(here::here("R", "query_tables_db_fxns.R"))
```

    Loading required package: DBI


    Attaching package: 'dplyr'

    The following objects are masked from 'package:stats':

        filter, lag

    The following objects are masked from 'package:base':

        intersect, setdiff, setequal, union

``` r
source(here::here("R", "query_saplings.R"))

con <- connect_to_tables(here::here("data", "db", "foresttime-from-state-parquet.duckdb"))
```

``` r
saplings_mn <- query_saplings(con, 
                              conditions = create_conditions(
                                STATECD == 27
                              ))
```

    Joining with `by = join_by(PLOT_COMPOSITE_ID, INVYR)`

``` r
knitr::kable(head(saplings_mn, 40))
```

| PLOT_COMPOSITE_ID |  PLOT | COUNTYCD | STATECD |       PLT_CN | INVYR | PREV_INVYR | CYCLE | timespan | PREV_live_sapling | PREV_live_and_skipped | sapling_sapling_prop | sapling_tree_prop | sapling_removed_prop | presumed_dead_prop | sapling_not_sampled_prop | sapling_missing_data_prop | sapling_skipped_prop |
|:------------------|------:|---------:|--------:|-------------:|------:|-----------:|------:|---------:|------------------:|----------------------:|---------------------:|------------------:|---------------------:|-------------------:|-------------------------:|--------------------------:|---------------------:|
| 27_1_137_10496    | 10496 |      137 |      27 | 1.691061e+14 |  2010 |       2005 |    14 |        5 |                 1 |                     1 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_10496    | 10496 |      137 |      27 | 2.317359e+14 |  2015 |       2010 |    15 |        5 |                 4 |                     4 |            0.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                1.0000000 |                         0 |                    0 |
| 27_1_137_20215    | 20215 |      137 |      27 | 1.691054e+14 |  2010 |       2005 |    14 |        5 |                 1 |                     1 |            0.0000000 |         0.0000000 |            0.0000000 |          1.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20215    | 20215 |      137 |      27 | 2.317354e+14 |  2015 |       2010 |    15 |        5 |                 2 |                     2 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20215    | 20215 |      137 |      27 | 6.105549e+14 |  2020 |       2015 |    16 |        5 |                 8 |                     8 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20221    | 20221 |      137 |      27 | 2.317356e+14 |  2015 |       2010 |    15 |        5 |                 1 |                     1 |            0.0000000 |         0.0000000 |            0.0000000 |          1.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20260    | 20260 |      137 |      27 | 1.024588e+14 |  2006 |       2001 |    13 |        5 |                 1 |                     1 |            0.0000000 |         0.0000000 |            0.0000000 |          1.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20260    | 20260 |      137 |      27 | 2.213472e+14 |  2011 |       2006 |    14 |        5 |                 6 |                     6 |            0.8333333 |         0.0000000 |            0.0000000 |          0.1666667 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20260    | 20260 |      137 |      27 | 3.001617e+14 |  2016 |       2011 |    15 |        5 |                 9 |                     9 |            0.5555556 |         0.0000000 |            0.0000000 |          0.0000000 |                0.4444444 |                         0 |                    0 |
| 27_1_137_20260    | 20260 |      137 |      27 | 7.218260e+14 |  2021 |       2016 |    16 |        5 |                13 |                    13 |            0.8461538 |         0.1538462 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20262    | 20262 |      137 |      27 | 1.024588e+14 |  2006 |       2001 |    13 |        5 |                14 |                    14 |            0.5714286 |         0.0000000 |            0.0000000 |          0.4285714 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20262    | 20262 |      137 |      27 | 2.213472e+14 |  2011 |       2006 |    14 |        5 |                11 |                    11 |            0.7272727 |         0.1818182 |            0.0000000 |          0.0909091 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20262    | 20262 |      137 |      27 | 3.001617e+14 |  2016 |       2011 |    15 |        5 |                 8 |                     8 |            0.1250000 |         0.5000000 |            0.0000000 |          0.3750000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20262    | 20262 |      137 |      27 | 7.218260e+14 |  2021 |       2016 |    16 |        5 |                 1 |                     1 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20269    | 20269 |      137 |      27 | 1.024623e+14 |  2006 |       2001 |    13 |        5 |                 4 |                     4 |            0.7500000 |         0.0000000 |            0.0000000 |          0.2500000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20269    | 20269 |      137 |      27 | 2.213494e+14 |  2011 |       2006 |    14 |        5 |                 3 |                     3 |            0.6666667 |         0.0000000 |            0.0000000 |          0.3333333 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20269    | 20269 |      137 |      27 | 3.001631e+14 |  2016 |       2011 |    15 |        5 |                 3 |                     3 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20269    | 20269 |      137 |      27 | 7.218274e+14 |  2021 |       2016 |    16 |        5 |                 4 |                     4 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20282    | 20282 |      137 |      27 | 1.083019e+14 |  2009 |       2004 |    14 |        5 |                18 |                    18 |            0.9444444 |         0.0000000 |            0.0555556 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20282    | 20282 |      137 |      27 | 1.712562e+14 |  2014 |       2009 |    15 |        5 |                19 |                    19 |            0.8947368 |         0.0526316 |            0.0000000 |          0.0526316 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20282    | 20282 |      137 |      27 | 5.140796e+14 |  2019 |       2014 |    16 |        5 |                21 |                    21 |            0.8095238 |         0.0000000 |            0.0000000 |          0.1904762 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20297    | 20297 |      137 |      27 | 1.025629e+14 |  2007 |       2002 |    13 |        5 |                 4 |                     4 |            0.5000000 |         0.0000000 |            0.0000000 |          0.5000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20297    | 20297 |      137 |      27 | 2.423810e+14 |  2012 |       2007 |    14 |        5 |                 3 |                     3 |            0.3333333 |         0.3333333 |            0.0000000 |          0.3333333 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20303    | 20303 |      137 |      27 | 2.423809e+14 |  2012 |       2007 |    14 |        5 |                30 |                    30 |            0.8666667 |         0.0000000 |            0.0000000 |          0.1333333 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20303    | 20303 |      137 |      27 | 3.727862e+14 |  2017 |       2012 |    15 |        5 |                28 |                    28 |            0.6071429 |         0.0357143 |            0.0000000 |          0.3571429 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20375    | 20375 |      137 |      27 | 1.712556e+14 |  2014 |       2004 |    15 |       10 |                 7 |                     7 |            0.0000000 |         0.0000000 |            0.0000000 |          1.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20375    | 20375 |      137 |      27 | 5.140807e+14 |  2019 |       2014 |    16 |        5 |                15 |                    15 |            0.8000000 |         0.1333333 |            0.0000000 |          0.0666667 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20379    | 20379 |      137 |      27 | 1.083016e+14 |  2009 |       2004 |    14 |        5 |                 2 |                     2 |            0.0000000 |         1.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20379    | 20379 |      137 |      27 | 1.712561e+14 |  2014 |       2009 |    15 |        5 |                 0 |                     0 |                   NA |                NA |                   NA |                 NA |                       NA |                        NA |                   NA |
| 27_1_137_20379    | 20379 |      137 |      27 | 5.140802e+14 |  2019 |       2014 |    16 |        5 |                 0 |                     0 |                   NA |                NA |                   NA |                 NA |                       NA |                        NA |                   NA |
| 27_1_137_20389    | 20389 |      137 |      27 | 1.083014e+14 |  2009 |       2004 |    14 |        5 |                10 |                    10 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20389    | 20389 |      137 |      27 | 5.140808e+14 |  2019 |       2014 |    16 |        5 |                23 |                    23 |            0.9130435 |         0.0000000 |            0.0000000 |          0.0869565 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20440    | 20440 |      137 |      27 | 1.083009e+14 |  2009 |       2004 |    14 |        5 |                 1 |                     1 |            0.0000000 |         0.0000000 |            0.0000000 |          1.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20440    | 20440 |      137 |      27 | 1.712558e+14 |  2014 |       2009 |    15 |        5 |                 3 |                     3 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20440    | 20440 |      137 |      27 | 5.140795e+14 |  2019 |       2014 |    16 |        5 |                 7 |                     7 |            0.5714286 |         0.0000000 |            0.0000000 |          0.0000000 |                0.4285714 |                         0 |                    0 |
| 27_1_137_20448    | 20448 |      137 |      27 | 1.712573e+14 |  2014 |       2009 |    15 |        5 |                 4 |                     4 |            0.7500000 |         0.0000000 |            0.0000000 |          0.2500000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20448    | 20448 |      137 |      27 | 5.140801e+14 |  2019 |       2014 |    16 |        5 |                 3 |                     3 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20466    | 20466 |      137 |      27 | 1.083009e+14 |  2009 |       2004 |    14 |        5 |                 7 |                     7 |            0.7142857 |         0.0000000 |            0.0000000 |          0.2857143 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20466    | 20466 |      137 |      27 | 1.712559e+14 |  2014 |       2009 |    15 |        5 |                 6 |                     6 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                0.0000000 |                         0 |                    0 |
| 27_1_137_20466    | 20466 |      137 |      27 | 5.140795e+14 |  2019 |       2014 |    16 |        5 |                 7 |                     7 |            0.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                1.0000000 |                         0 |                    0 |

``` r
dbDisconnect(con, shutdown = TRUE)
```
