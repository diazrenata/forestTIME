# Extract sapling transition tables


# Pulling trees

``` r
source(here::here("R", "query_tables_db_fxns.R"))
```

    Loading required package: DBI


    Attaching package: 'dplyr'

    The following objects are masked from 'package:stats':

        filter, lag

    The following objects are masked from 'package:base':

        intersect, setdiff, setequal, union

``` r
source(here::here("R", "query_saplings.R"))

con <- connect_to_tables(here::here("data", "db", "foresttime-from-state-parquet.duckdb"))
```

``` r
saplings_mn <- query_saplings(con, 
                              conditions = create_conditions(
                                STATECD == 27
                              ))
```

    Joining with `by = join_by(PLOT_COMPOSITE_ID, INVYR)`

``` r
knitr::kable(head(saplings_mn, 40))
```

| PLOT_COMPOSITE_ID |  PLOT | COUNTYCD | STATECD |       PLT_CN | INVYR | PREV_INVYR | CYCLE | timespan | PREV_live_sapling | PREV_live_and_skipped | sapling_sapling_prop | sapling_tree_prop | sapling_removed_prop | presumed_dead_prop | sapling_not_sampled_prop | sapling_missing_data_prop | sapling_skipped_prop |
|:------------------|------:|---------:|--------:|-------------:|------:|-----------:|------:|---------:|------------------:|----------------------:|---------------------:|------------------:|---------------------:|-------------------:|-------------------------:|--------------------------:|---------------------:|
| 27_1_137_20242    | 20242 |      137 |      27 | 2.317369e+14 |  2015 |       2010 |    15 |        5 |                 3 |                     3 |            0.6666667 |         0.0000000 |            0.0000000 |          0.3333333 |                      0.0 |                         0 |                    0 |
| 27_1_137_20242    | 20242 |      137 |      27 | 6.105543e+14 |  2020 |       2015 |    16 |        5 |                 4 |                     4 |            0.7500000 |         0.0000000 |            0.0000000 |          0.2500000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20268    | 20268 |      137 |      27 | 1.024591e+14 |  2006 |       2001 |    13 |        5 |                 3 |                     3 |            0.6666667 |         0.3333333 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20268    | 20268 |      137 |      27 | 2.213473e+14 |  2011 |       2006 |    14 |        5 |                 2 |                     2 |            0.5000000 |         0.5000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20268    | 20268 |      137 |      27 | 3.001621e+14 |  2016 |       2011 |    15 |        5 |                 2 |                     2 |            0.0000000 |         0.0000000 |            1.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20268    | 20268 |      137 |      27 | 7.218265e+14 |  2021 |       2016 |    16 |        5 |                 0 |                     0 |                   NA |                NA |                   NA |                 NA |                       NA |                        NA |                   NA |
| 27_1_137_20315    | 20315 |      137 |      27 | 1.025623e+14 |  2007 |       2002 |    13 |        5 |                 2 |                     2 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20315    | 20315 |      137 |      27 | 3.727864e+14 |  2017 |       2012 |    15 |        5 |                31 |                    31 |            0.7419355 |         0.0322581 |            0.0000000 |          0.2258065 |                      0.0 |                         0 |                    0 |
| 27_1_137_20336    | 20336 |      137 |      27 | 1.021499e+14 |  2008 |       2003 |    13 |        5 |                 9 |                     9 |            0.7777778 |         0.0000000 |            0.0000000 |          0.2222222 |                      0.0 |                         0 |                    0 |
| 27_1_137_20336    | 20336 |      137 |      27 | 4.490731e+14 |  2018 |       2013 |    15 |        5 |                 5 |                     5 |            0.8000000 |         0.0000000 |            0.0000000 |          0.2000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20383    | 20383 |      137 |      27 | 1.083016e+14 |  2009 |       2004 |    14 |        5 |                 2 |                     2 |            0.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      1.0 |                         0 |                    0 |
| 27_1_137_20383    | 20383 |      137 |      27 | 1.712561e+14 |  2014 |       2009 |    15 |        5 |                 7 |                     7 |            0.0000000 |         0.0000000 |            0.0000000 |          1.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20383    | 20383 |      137 |      27 | 5.140796e+14 |  2019 |       2014 |    16 |        5 |                 5 |                     5 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20426    | 20426 |      137 |      27 | 1.712558e+14 |  2014 |       2009 |    15 |        5 |                35 |                    35 |            0.9142857 |         0.0000000 |            0.0000000 |          0.0857143 |                      0.0 |                         0 |                    0 |
| 27_1_137_20458    | 20458 |      137 |      27 | 1.083012e+14 |  2009 |       2004 |    14 |        5 |                 3 |                     3 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20458    | 20458 |      137 |      27 | 1.712559e+14 |  2014 |       2009 |    15 |        5 |                 5 |                     5 |            0.6000000 |         0.2000000 |            0.0000000 |          0.2000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20458    | 20458 |      137 |      27 | 5.140807e+14 |  2019 |       2014 |    16 |        5 |                 4 |                     4 |            0.0000000 |         0.0000000 |            0.0000000 |          1.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_20459    | 20459 |      137 |      27 | 1.083014e+14 |  2009 |       2004 |    14 |        5 |                13 |                    13 |            0.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      1.0 |                         0 |                    0 |
| 27_1_137_25044    | 25044 |      137 |      27 | 9.896042e+13 |  2005 |       2000 |    13 |        5 |                12 |                    12 |            0.8333333 |         0.0000000 |            0.0000000 |          0.1666667 |                      0.0 |                         0 |                    0 |
| 27_1_137_25044    | 25044 |      137 |      27 | 1.691085e+14 |  2010 |       2005 |    14 |        5 |                12 |                    12 |            0.8333333 |         0.0833333 |            0.0000000 |          0.0833333 |                      0.0 |                         0 |                    0 |
| 27_1_137_25044    | 25044 |      137 |      27 | 2.317371e+14 |  2015 |       2010 |    15 |        5 |                13 |                    13 |            0.7692308 |         0.0769231 |            0.0000000 |          0.1538462 |                      0.0 |                         0 |                    0 |
| 27_1_137_25044    | 25044 |      137 |      27 | 6.105549e+14 |  2020 |       2015 |    16 |        5 |                10 |                    10 |            0.2000000 |         0.0000000 |            0.0000000 |          0.5000000 |                      0.3 |                         0 |                    0 |
| 27_1_137_25144    | 25144 |      137 |      27 | 3.727878e+14 |  2017 |       2012 |    15 |        5 |                24 |                    24 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25165    | 25165 |      137 |      27 | 1.024541e+14 |  2006 |       2001 |    13 |        5 |                10 |                    10 |            0.9000000 |         0.0000000 |            0.0000000 |          0.1000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25165    | 25165 |      137 |      27 | 2.213451e+14 |  2011 |       2006 |    14 |        5 |                21 |                    21 |            0.9523810 |         0.0476190 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25165    | 25165 |      137 |      27 | 3.001609e+14 |  2016 |       2011 |    15 |        5 |                26 |                    26 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25165    | 25165 |      137 |      27 | 7.218253e+14 |  2021 |       2016 |    16 |        5 |                34 |                    34 |            0.8823529 |         0.0294118 |            0.0000000 |          0.0882353 |                      0.0 |                         0 |                    0 |
| 27_1_137_25166    | 25166 |      137 |      27 | 1.021478e+14 |  2008 |       2003 |    13 |        5 |                 5 |                     5 |            0.6000000 |         0.0000000 |            0.0000000 |          0.4000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25166    | 25166 |      137 |      27 | 1.573902e+13 |  2013 |       2008 |    14 |        5 |                 6 |                     6 |            0.8333333 |         0.0000000 |            0.0000000 |          0.1666667 |                      0.0 |                         0 |                    0 |
| 27_1_137_25166    | 25166 |      137 |      27 | 4.490713e+14 |  2018 |       2013 |    15 |        5 |                 7 |                     7 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25180    | 25180 |      137 |      27 | 1.025573e+14 |  2007 |       2002 |    13 |        5 |                14 |                    14 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25180    | 25180 |      137 |      27 | 2.423801e+14 |  2012 |       2007 |    14 |        5 |                15 |                    15 |            0.3333333 |         0.0000000 |            0.2000000 |          0.4666667 |                      0.0 |                         0 |                    0 |
| 27_1_137_25180    | 25180 |      137 |      27 | 3.727858e+14 |  2017 |       2012 |    15 |        5 |                 6 |                     6 |            0.1666667 |         0.0000000 |            0.0000000 |          0.8333333 |                      0.0 |                         0 |                    0 |
| 27_1_137_25186    | 25186 |      137 |      27 | 1.025575e+14 |  2007 |       2002 |    13 |        5 |                 2 |                     2 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25186    | 25186 |      137 |      27 | 2.423800e+14 |  2012 |       2007 |    14 |        5 |                10 |                    10 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25186    | 25186 |      137 |      27 | 3.727847e+14 |  2017 |       2012 |    15 |        5 |                13 |                    13 |            0.8461538 |         0.0769231 |            0.0000000 |          0.0769231 |                      0.0 |                         0 |                    0 |
| 27_1_137_25189    | 25189 |      137 |      27 | 1.024533e+14 |  2006 |       2001 |    13 |        5 |                 2 |                     2 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25189    | 25189 |      137 |      27 | 2.213457e+14 |  2011 |       2006 |    14 |        5 |                12 |                    12 |            1.0000000 |         0.0000000 |            0.0000000 |          0.0000000 |                      0.0 |                         0 |                    0 |
| 27_1_137_25189    | 25189 |      137 |      27 | 7.218258e+14 |  2021 |       2016 |    16 |        5 |                22 |                    22 |            0.6818182 |         0.0454545 |            0.0454545 |          0.2272727 |                      0.0 |                         0 |                    0 |
| 27_1_137_25206    | 25206 |      137 |      27 | 1.082957e+14 |  2009 |       2004 |    14 |        5 |                10 |                    10 |            0.9000000 |         0.0000000 |            0.0000000 |          0.1000000 |                      0.0 |                         0 |                    0 |

``` r
dbDisconnect(con, shutdown = TRUE)
```
